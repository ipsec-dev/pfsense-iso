name: Publish pfSense ISO

on:
  workflow_dispatch:

jobs:
  download-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Set up variables and find latest ISO
        run: |
          URL="https://atxfiles.netgate.com/mirror/downloads"
          FILE=$(curl -s "$URL/" | grep -oP 'pfSense-CE-\d+\.\d+\.\d+-RELEASE-amd64\.iso\.gz' | sort -V | tail -n1)
          VERSION=$(echo "$FILE" | sed 's/.iso.gz//' )
          ISO_FILE="${FILE%.gz}"
          echo "URL=$URL" >> $GITHUB_ENV
          echo "LATEST_FILE=$FILE" >> $GITHUB_ENV
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "ISO_FILE=$ISO_FILE" >> $GITHUB_ENV

      - name: Download ISO and checksum
        run: |
          curl -LO "$URL/${{ env.LATEST_FILE }}"
          curl -LO "$URL/${{ env.LATEST_FILE }}.sha256"

      - name: Verify SHA256 checksum
        run: |
          sha256sum -c "${{ env.LATEST_FILE }}.sha256"

      - name: Unzip ISO
        run: |
          gunzip "${{ env.LATEST_FILE }}"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.RELEASE_VERSION }}
          tag_name: ${{ env.RELEASE_VERSION }}
          files: ${{ env.ISO_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
