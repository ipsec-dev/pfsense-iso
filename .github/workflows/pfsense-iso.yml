name: Publish pfSense ISO

on:
  workflow_dispatch:

jobs:
  download-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Set up variables and find latest ISO
        run: |
          URL="https://atxfiles.netgate.com/mirror/downloads"
          FILE=$(curl -s "$URL/" | grep -oP 'pfSense-CE-\d+\.\d+\.\d+-RELEASE-amd64\.iso\.gz' | sort -V | tail -n1)
          VERSION=$(echo "$FILE" | sed 's/.iso.gz//' )
          ISO_FILE="${FILE%.gz}"
          SHA_FILE="${ISO_FILE}.sha256"
          echo "URL=$URL" >> $GITHUB_ENV
          echo "LATEST_FILE=$FILE" >> $GITHUB_ENV
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "ISO_FILE=$ISO_FILE" >> $GITHUB_ENV
          echo "SHA_FILE=$SHA_FILE" >> $GITHUB_ENV

      - name: Download ISO and raw checksum
        run: |
          curl -LO "$URL/${{ env.LATEST_FILE }}"
          curl -LO "$URL/${{ env.LATEST_FILE }}.sha256"

      - name: Verify original SHA256
        run: |
          sha256sum -c "${{ env.LATEST_FILE }}.sha256"

      - name: Unzip ISO
        run: |
          gunzip "${{ env.LATEST_FILE }}"

      - name: Rewrite SHA256 file in desired format
        run: |
          HASH=$(cut -d '=' -f2 "${{ env.LATEST_FILE }}.sha256" | tr -d ' ')
          echo "$HASH ${{ env.ISO_FILE }}" > "${{ env.SHA_FILE }}"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.RELEASE_VERSION }}
          tag_name: ${{ env.RELEASE_VERSION }}
          files: |
            ${{ env.ISO_FILE }}
            ${{ env.SHA_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
